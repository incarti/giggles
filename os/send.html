<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>//INCARTI</title>
  <meta name="description" content="">
  <meta name="author" content="">

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">



  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->


  <link rel="stylesheet" href="style.css">
  <script src="editor.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/promise.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radix.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/radisk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/store.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/gun/lib/rindexed.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@2.0.11/dist/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>

  <style>
      div#medium-editor-toolbar-5{
          display: none;
      }
  </style>


</head>
<body>
    <div class="app">
        <div class="wrapper">
            <div class="left-side">
                <div class="side-wrapper">

                    <div class="content-section">
                        <br>
  
                          <h4 id="content">Anonymous Mode</h4>
  
                          <a href="index.html"><h1 id="content" style="font-family: arialBlack;">REVOLUT/OS </h1></a>
  
                     </div>

          




                    <div class="content-section" style="position: absolute; bottom: 30px;">

                        <h3 id="savedText" class="lang" key="saved" > </h3>

                    
                        

            
                        <h5><div id="status"></div></h5>

                        <ul style="background-color: var(--content-bg);">

                        </li> 
                          <li class="product" >

                            

                            <div class="half" style="display: inline-block; width: 40%; overflow: hidden;">
                                <h3 style="color: grey;">To  &emsp;</h3>
                                <h3 id="wallet"></h3>
                            </div><div class="half" style="display: inline-block; width: 10%">
  
                            </div><div class="half" style="display: inline-block; width: 50%">
                                    <h3 style="color: grey;">Total</h3>
                                    <h3 >$---</h3>
                                </div>
                        </li>

                        </ul>

                        <div class="half" style="display: inline-block; width: 50%; margin-top: 2em;">
                            <ul style="background-color: white;">
                                <h3 style="color: grey;">Eth</h3>
                                <h3 id="price"></h3></div><div class="half" style="display: inline-block; width: 50%">

                                <button class="pay-button content-button" style="width: 12em; margin-top: -3em; color: white;"><h2>Pay</h2></button >
                            </ul>
                         </div>

                    
        
        
        
                        <script>
                                const peers = ['https://gun-us.herokuapp.com/gun','https://gun-eu.herokuapp.com/gun', 'https://gunjs.herokuapp.com/gun'];
                                const gun = Gun({localStorage:false, peers:peers});
                                const user = gun.user();
                                const SEA = Gun.SEA;
                                var myKeys = {};
                                var urlPassword = '';
                                var currentTitle = '';
                                var hash = '';
                                const savedTextEl = document.getElementById('savedText');
            
                                async function publish() {
                                    localStorage.setItem(myKeys.pub, JSON.stringify(myKeys));
                                    await gun.get(`APAC#`).get(hash).promPut(myKeys.pub); 
                                    var url = `?t=${encodeURIComponent(currentTitle.replace(/\s+/g, '-').toLowerCase())}&p=${urlPassword}#${hash}`
                                    history.pushState({},'', url);
                                    location.reload();
                                }
            
                                function copyLink(buttonElement) {
                                navigator.clipboard.writeText(location.href).then(function() {
                                    buttonElement.innerText = 'Copied';
                                }, function() {
                                    buttonElement.innerText = 'Copy permissions denied';
                                });
                                }
            
                                function deleteArticle(buttonElement) {
                                    user.get('articles').get(hash).map().once(async (node, nodeID) => {
                                        user.get('articles').get(hash).get(nodeID).promPut(null);
                                    })
                                    localStorage.removeItem(myKeys.pub);
                                    buttonElement.innerText = 'Deleted';
                                }
            
                                function debounce(func, delay) {
                                    let inDebounce
                                    return function() {
                                        const context = this
                                        const args = arguments
                                        clearTimeout(inDebounce)
                                        inDebounce = setTimeout(() => func.apply(context, args), delay)
                                    }
                                }
            
                                async function save(event, editable) {
                                    savedTextEl.classList.remove('fadeInAndOut');
                                    void savedTextEl.offsetWidth;
                                    
                                    var content = '';
                                    var name = '';
                                    if (event.id){
                                        name = event.id
                                        content = event.value
                                    } else if (event.target) {
                                        name = event.target.id
                                        content = editable.innerHTML;
                                    }
                                    if (name === 'title') { currentTitle = editable.innerText }
                                    var encNode = await SEA.encrypt(content, urlPassword)
                                    await user.get('articles').get(hash).get(name).promPut(encNode)
                                    var encTime = await SEA.encrypt(new Date().toUTCString(), urlPassword)
                                    await user.get('articles').get(hash).get('lastUpdated').promPut(encTime);
            
                                    savedTextEl.classList.add('fadeInAndOut');
                                }
            
                                function renderArticle(authorPub, articleHash, audienceType) {
                                    if (audienceType == 'create') {
                                        var editorTitle = new MediumEditor('#title', {placeholder: {
                                            text: 'STORE',
                                            hideOnClick: false
                                        }, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorAuthor = new MediumEditor('#author', {placeholder: {
                                            text: 'NAME',
                                            hideOnClick: false
                                        }, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorWallet = new MediumEditor('#wallet', {placeholder: {
                                            text: 'WALLET ADDRESS',
                                            hideOnClick: false
                                        }, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorPrice = new MediumEditor('#price', {placeholder: {
                                            text: 'PRICE',
                                            hideOnClick: false
                                        }, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorContent = new MediumEditor('#content', {
                                            placeholder: {
                                                text: 'PRODUCT',
                                                hideOnClick: false
                                            }, 
                                            spellcheck: true,
                                            autoLink: true,
                                            toolbar: { 
                                                buttons: ['bold', 'italic', 'underline', 'anchor', 'h2', 'h3', 'quote', 'pre', 'unorderedlist','orderedlist'] 
                                            }
                                        });
                                        editorTitle.subscribe('editableInput', debounce(save, 1000));
                                        editorAuthor.subscribe('editableInput', debounce(save, 1000));
                                        editorWallet.subscribe('editableInput', debounce(save, 1000));
                                        editorPrice.subscribe('editableInput', debounce(save, 1000));
                                        editorContent.subscribe('editableInput', debounce(save, 1000));
            
                                        document.getElementById('publishButton').style.cssText = "";
                                        document.getElementById('about').style.cssText = "";
                                    } 
                                    else if (audienceType == 'read') {
                                        gun.get(`~${authorPub}`).get('articles').get(articleHash).map().once(async (node, nodeID) => {
                                            if (nodeID !== 'pass') {
                                                var decNode = await SEA.decrypt(node, urlPassword);
                                                if (nodeID == 'verification') {
                                                    document.getElementById('verification').outerHTML = `<a href="${DOMPurify.sanitize(decNode)}">${DOMPurify.sanitize(decNode)}</a>`;
                                                    document.getElementById('verificationSection').style.display = "";
                                                } else {
                                                    document.getElementById(nodeID).innerHTML = DOMPurify.sanitize(decNode);
                                                }
                                            }
                                        })
                                        document.getElementById('meta').style.display = "";
                                        document.getElementById('copyButton').style.display = "";
                                    } 
                                    else if (audienceType == 'update') {
                                        gun.get(`~${authorPub}`).get('articles').get(articleHash).map().once(async (node, nodeID) => {
                                            if (nodeID !== 'pass') {
                                                var decNode = await SEA.decrypt(node, urlPassword);
                                                if (nodeID == 'verification') {
                                                    document.getElementById(nodeID).value = DOMPurify.sanitize(decNode);
                                                } else {
                                                    document.getElementById(nodeID).innerHTML = DOMPurify.sanitize(decNode);
                                                }
                                            }
                                        })
                                        
                                        var editorTitle = new MediumEditor('#title', {placeholder: false, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorAuthor = new MediumEditor('#author', {placeholder: false, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorWallet = new MediumEditor('#wallet', {placeholder: false, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorPrice = new MediumEditor('#price', {placeholder: false, spellcheck: false, disableReturn: true,toolbar: false});
                                        var editorContent = new MediumEditor('#content', {
                                            placeholder: false, 
                                            spellcheck: true, 
                                            autoLink: true,
                                            toolbar: { 
                                                buttons: ['bold', 'italic', 'underline', 'anchor', 'h2', 'h3', 'quote', 'pre', 'unorderedlist','orderedlist'] 
                                            }
                                        });
                                        editorTitle.subscribe('editableInput', debounce(save, 1000));
                                        editorAuthor.subscribe('editableInput', debounce(save, 1000));
                                        editorWallet.subscribe('editableInput', debounce(save, 1000));
                                        editorPrice.subscribe('editableInput', debounce(save, 1000));
                                        editorContent.subscribe('editableInput', debounce(save, 1000));
            
                                        document.getElementById('meta').style.display = "";
                                        document.getElementById('copyButton').style.display = "";
                                        document.getElementById('verificationSection').style.display = "";
                                        document.getElementById('deleteButton').style.display = "";
                                    }
                                    document.getElementById('app').style.cssText = "";
                                }
                                
                                async function go() {
                                    if (window.location.search) {
                                        urlPassword = new URLSearchParams(window.location.search).get("p");
                                        hash = window.location.hash.slice(1)
                                        var authorPubKey = await gun.get('APAC#').get(hash).promOnce();
                                        authorPubKey = authorPubKey.data
                                        var localstorageKeyPair = localStorage.getItem(authorPubKey);
                                        if (localstorageKeyPair) {
                                            myKeys = JSON.parse(localstorageKeyPair);
                                            user.auth(myKeys);
                                            if (user.is) {
                                                renderArticle(authorPubKey, hash, 'update');
                                            }
                                        } else {
                                            renderArticle(authorPubKey, hash, 'read');
                                        }
                                    } else {
                                        myKeys = await SEA.pair();
                                        urlPassword = SEA.random(11).toString('hex');
                                        user.auth(myKeys);
                                        hash = await SEA.work(myKeys.pub, null, null, {name: "SHA-256"});
                                        var encPass = await SEA.encrypt(urlPassword, myKeys);
                                        await user.get('articles').get(hash).get('pass').promPut(encPass);
                                        renderArticle(myKeys.pub, hash, 'create');
                                    }
                                }
                                go();
                        </script>
                        <script type="text/javascript">
                            window.addEventListener('load', async () => {
                            if (window.ethereum) {
                                window.web3 = new Web3(ethereum);
                                try {
                                await ethereum.enable();
                                initPayButton()
                                } catch (err) {
                                $('#status').html('User denied account access', err)
                                }
                            } else if (window.web3) {
                                window.web3 = new Web3(web3.currentProvider)
                                initPayButton()
                            } else {
                                $('#status').html('No Metamask (or other Web3 Provider) installed')
                            }
                            })
                        
                            const initPayButton = () => {
                            $('.pay-button').click(() => {
                                // paymentAddress is where funds will be send to
                                // code beneath not safe - dont push to production
                                const paymentAddress = document.getElementById("wallet").innerHTML
                                // code beneath not safe - dont push to production
                                const amountEth = document.getElementById("price").innerHTML
            
                        
                        
                                web3.eth.sendTransaction({
                                to: paymentAddress,
                                value: web3.toWei(amountEth, 'ether')
                                }, (err, transactionId) => {
                                if  (err) {
                                    console.log('Payment failed', err)
                                    $('#status').html('Payment failed')
                                } else {
                                    console.log('Payment successful', transactionId)
                                    $('#status').html('Payment successful')
                                }
                                })
                            })
                            }
                        </script>
                </div>
            </div>
        </div>
    </div>
<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>
